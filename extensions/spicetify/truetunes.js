// TrueTunes Spicetify Extension
// Detects AI-generated music on Spotify

(function TrueTunes() {
    const GITHUB_RAW = "https://raw.githubusercontent.com/Lewdcifer666/TrueTunes/main/data/flagged.json";
    const ISSUE_URL = "https://github.com/Lewdcifer666/TrueTunes/issues/new";

    let flaggedArtists = new Map();
    let settings = {
        autoSkip: false,
        autoDislike: false,
        showWarnings: true,
        confidenceThreshold: 0.75
    };

    // Load settings from localStorage
    function loadSettings() {
        const saved = localStorage.getItem('truetunes_settings');
        if (saved) {
            settings = { ...settings, ...JSON.parse(saved) };
        }
    }

    // Save settings to localStorage
    function saveSettings() {
        localStorage.setItem('truetunes_settings', JSON.stringify(settings));
    }

    // Load flagged artists list
    async function loadFlaggedList() {
        try {
            const response = await fetch(GITHUB_RAW + '?t=' + Date.now());
            const data = await response.json();

            flaggedArtists.clear();
            data.artists.forEach(artist => {
                if (artist.platforms.spotify) {
                    flaggedArtists.set(artist.platforms.spotify, artist);
                }
            });

            console.log('[TrueTunes] Loaded', flaggedArtists.size, 'flagged artists');
        } catch (error) {
            console.error('[TrueTunes] Failed to load list:', error);
        }
    }

    // Check current track
    function checkCurrentTrack() {
        if (!Spicetify.Player.data || !Spicetify.Player.data.item) return;

        const item = Spicetify.Player.data.item;

        // Try multiple ways to get artist URI (Spotify API changes)
        let artistUri = item.metadata?.reason_artist ||
            item.metadata?.artist_uri ||
            (item.artists && item.artists[0]?.uri);

        if (!artistUri) {
            console.log('[TrueTunes] No artist URI found');
            return;
        }

        const artistId = artistUri.split(':').pop();
        const flagged = flaggedArtists.get(artistId);

        console.log('[TrueTunes] Checking artist:', artistId, flagged ? '- FLAGGED!' : '- clean');

        if (flagged && flagged.confidence >= settings.confidenceThreshold) {
            handleFlaggedTrack(flagged);
        }
    }

    // Handle flagged track
    function handleFlaggedTrack(artist) {
        if (settings.showWarnings) {
            showNotification(artist);
        }

        if (settings.autoSkip) {
            setTimeout(() => Spicetify.Player.next(), 500);
        }

        if (settings.autoDislike) {
            dislikeTrack();
        }
    }

    // Show notification
    function showNotification(artist) {
        const confidence = Math.round(artist.confidence * 100);
        Spicetify.showNotification(
            `⚠️ AI Generated Music Detected (${confidence}% confidence)`,
            false,
            5000
        );
    }

    // Dislike track
    function dislikeTrack() {
        try {
            const uri = Spicetify.Player.data.track.uri;
            Spicetify.Platform.LibraryAPI.remove({ uris: [uri] });
        } catch (error) {
            console.error('[TrueTunes] Failed to dislike:', error);
        }
    }

    // Vote on current artist
    function voteOnArtist(voteType) {
        const track = Spicetify.Player.data.track;
        const artistName = track.metadata.artist_name;
        const artistId = track.metadata.artist_uri.split(':').pop();

        const title = `Vote: ${artistName}`;
        const body = `Platform: Spotify\nArtist ID: ${artistId}\nVote: ${voteType}\n\nAuto-generated by TrueTunes extension`;

        const url = `${ISSUE_URL}?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}&labels=vote`;

        window.open(url, '_blank');
        Spicetify.showNotification('✓ Vote submitted! Thanks for contributing.', false, 3000);
    }

    // Wait for ALL required Spicetify components
    function registerContextMenu() {
        if (!Spicetify.ContextMenu || !Spicetify.React || !Spicetify.ReactDOM) {
            setTimeout(registerContextMenu, 300);
            return;
        }

        // Also wait a bit longer to be safe
        setTimeout(() => {
            try {
                new Spicetify.ContextMenu.Item(
                    "TrueTunes: Vote AI Generated",
                    async ([uri]) => {
                        const artistId = uri.split(':')[2];

                        let artistName = "Unknown Artist";
                        try {
                            const item = Spicetify.Player.data?.item;
                            if (item && item.artists && item.artists[0]) {
                                artistName = item.artists[0].name;
                            }
                        } catch (e) { }

                        const title = `Vote: ${artistName}`;
                        const body = `Platform: Spotify\nArtist ID: ${artistId}\nVote: ai\n\nAuto-generated by TrueTunes extension`;

                        const issueUrl = `https://github.com/Lewdcifer666/TrueTunes/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}&labels=vote`;

                        window.open(issueUrl, '_blank');
                        Spicetify.showNotification('✓ Vote submitted! Thanks for contributing.', false, 3000);
                    },
                    ([uri]) => {
                        return uri.split(':')[1] === 'artist';
                    },
                    `<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8z"/></svg>`
                ).register();

                new Spicetify.ContextMenu.Item(
                    "TrueTunes: Vote Human Artist",
                    async ([uri]) => {
                        const artistId = uri.split(':')[2];

                        let artistName = "Unknown Artist";
                        try {
                            const item = Spicetify.Player.data?.item;
                            if (item && item.artists && item.artists[0]) {
                                artistName = item.artists[0].name;
                            }
                        } catch (e) { }

                        const title = `Vote: ${artistName}`;
                        const body = `Platform: Spotify\nArtist ID: ${artistId}\nVote: human\n\nAuto-generated by TrueTunes extension`;

                        const issueUrl = `https://github.com/Lewdcifer666/TrueTunes/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}&labels=vote`;

                        window.open(issueUrl, '_blank');
                        Spicetify.showNotification('✓ Vote submitted! Thanks for contributing.', false, 3000);
                    },
                    ([uri]) => {
                        return uri.split(':')[1] === 'artist';
                    },
                    `<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"/></svg>`
                ).register();

                console.log('[TrueTunes] Context menu registered!');
            } catch (error) {
                console.error('[TrueTunes] Failed to register context menu:', error);
                // Try again
                setTimeout(registerContextMenu, 1000);
            }
        }, 1000);
    }

    // Start registration
    registerContextMenu();

    // Initialize
    async function init() {
        if (!Spicetify.Player || !Spicetify.Menu) {
            setTimeout(init, 100);
            return;
        }

        console.log('[TrueTunes] Initializing...');

        loadSettings();
        await loadFlaggedList();

        Spicetify.Player.addEventListener('songchange', checkCurrentTrack);

        // Auto-refresh every 6 hours
        setInterval(loadFlaggedList, 6 * 60 * 60 * 1000);

        console.log('[TrueTunes] Ready!');
    }

    init();
})();